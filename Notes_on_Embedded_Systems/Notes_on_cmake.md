NOTES ON CMAKE

-- based in : blog.adrianistan.eu/turotiral-de-cmake

WHAT IS CMAKE?
Cmake is a multi-platform tool, to generate compilation instructions for code. It can substute other systems like Make or MSBuild, and the compilation instructions will be modified 
according to the operating system that it is used. 

The advantage is that we only need to write one file to generate the compilation instructions. 

In Cmake the compilation instructions are defined in a file named 'CmakeList.txt'. It is usually defined 
at the base folder of the project. And the project is build in a folder named 'build'. 

# How to compile a program

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION 3.0) #define the minimun Cmake version

SET(MyProject_SRC "src/main.cpp") 
# We define the varible MyProject_SERC and set it's value to "src/main.cpp" 
# for several files, we can define several file locations, multi-line is allowed

ADD_EXECUTABLE(MyProject ${MyProject ${MyProject_SRC})
# Create an executable named "MyProject"
# The value of the varibles is retriebed with ${variable_name}
```

## c/c++ preprocessor definitions

It is possible to add preprocessor directives

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

ADD_DEFINITIONS(-DPREMIUM_SUPPORT)

ADD_EXECUTABLE(MyProject "src/main.cpp")
```

## C standard

from to cmake 3.1 it is possible to use the standard to be used


```
SET_PROPERTY(TARGET exectuable PROPERTY CXX_STARNDARD 17) # for c++17, it only affects the Executable target
SET(CMAKE_CXX_STANDARD 17)  @ for c++17, affects the whole project
```

# Using an static library

```
PROJECT(MyProject C CXX) 
# it is posible to define the languaje, so it is used by Cmake
CMAKE_MINIMUM_REQUIRED(VERSIO 3.0)

SET(MyProject_SRC "src/main.cpp")
SET(Lib_SRC "lib/lib.cpp")

ADD_LIBRARY(Lib STATIC ${Lib_SRC})
ADD_EXECUTABLE(MyProject ${MyProject_SRC})
TARGET_LINK_LIBRARIES(MyProject ${MyProjetc_SRC})
# if we need a given library we can add it like TARGET_LINK_LIBRARIES(MyProject pthread)

```

## Using a dynamic library

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION 3.0)

SET(MyProject_SRC "src/main.cpp")
SET(Lib_SRC "lib/lib.cpp")

ADD_LIBRARY(Lib SHARED ${Lib_SRC})
ADD_EXECUTABLE(MyProject ${MyProeject_SRC})
TARGET_LINK_LIBRARIES(MyProject ${MyProject_SRC})


## Rpath

rpath for *unix systems. to load dynamic libraries that are not located in the standard folders

```
SET(CMAKEE_SKIP_BUILD_RPATH FALSE)
SET(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE)
SET(CMAKE_INSTALL_RPATH "$ORIGIN")
SET(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)
```

# Adding files to the project

Get all the files with SET is very easy, in case we don't want to have to declare all the files to be used.

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION 3.0)

FILE(GLOB MyProeject_SRC "src/main.cpp")
#FILE GLOB selects all files that comply with a given characteristic. 
#GLOB is not recursive. If recursion is needed use GLOB_RECURSE

ADD_EXECUTABLE(MyProject ${MyProject_SRC})
```

# Create, delete, copy and downloading files

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION 3.0)

FILE(GLOB MyProject_SRC "src/*.cpp")

#create files
FILE(WRITE "Generated.txt" "This files has been generated by Cmake\n the files are: ${MyProeject_SRC}")

#delete files
FILE(REMOVE "Generated.txt")

#copy files
FILE(COPY "MyFile.cpp" DESTINATION my-folder)
#copy always defines as destination a folder
#if needed you can create the folder with: FILE(MAKE_DIRECTORY my-folder)


#Download files
FILE(DOWNLOAD http://my-server.com/myFile.tar.gz MyFile.tar.gz)
# to show the progress
FILE(DOWNLOAD http://my-server.com/myFile.tar.gz MyFile.tar.gz SHOW_PROGRESS)
# to check the MD5
FILE(DOWNLOAD http://my-server.com/myFile.tar.gz MyFile.tar.gz EXPECT_MD5 theMD5expected)
# to usse SSL
FILE(DOWNLOAD http://my-server.com/myFile.tar.gz MyFile.tar.gz EXPECT_MD5 TLS_VERIFY ON)
# to log into a file
FILE(DOWNLOAD http://my-server.com/myFile.tar.gz MyFile.tar.gz EXPECT_MD5 LOG myLog.log)

ADD_EXECUTABLE(MyProject ${MyProject_SRC})
```

# Including header files

To include header files in no standar locations

``` 
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

SET(MyProject_src 
    "src/main.cpp"
	"src/aux_code.cpp")
	
INCLUDE_DIRECTORIES("src/includes")
# this will add the directory to the compiler search path

ADD_EXECUTABLE(MyProject ${MyProyect_SRC})

## Showing messages, warnings and errors

So if under some conditions we don't want the code to compile, we can report it with MESSAGES

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

MESSAGE("any info message")
MESSAGE(STATUS "any no important message")
MESSAGE(WARNING "warngin! somewhat relevant message")
MESSAGE(SEND_ERROR "Error, the configuration will continue, but wont generate")
MESSAGE(FATAL_ERROR "falta error, stops configuration")

ADD_EXECUTABLE(MyProject "src/main.cpp")
```

## Advanced conditions

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

#with boolean variables: true/false"

IF(MyVariable)
MESSAGE("MyVariable is true")
ENDIF()

IF(NOT MyVariable)
MESSAGE("MyVarialbe is false")
ENDIF()

#the overall contion syntaxis is like:
IF(CONDITION)

ELSEIF(CONDITION2)

ELSE()

ENDIF()

#it is possible to use logical operators

IF(CONDITION AND CONDITION2)

IF(CONDITION OR CONDITION2)

# if the condition are numbers or text

IF(VAR1 LESS VAR2) 
IF(VAR1 GREATER VAR2)
IF(VAR1 EQUAL VAR2)
IF(VAR1 MATCHES REGEX) 

#also cmake has operator to work wit files, comamnds and executables

IF(DEFINED VAR1) #is VAR1 defined?

IF(COMMAND CMD1) #is CMD1 a CMAKE command?

IF(POLICY POL1) #is defined the directive POL1?

IF(TARGET MyProject) #is defined the executable MyProject?

IF(EXITS src/main.cpp) #does it exists the file src/main.cpp?

IF(src/main.cpp IS_NEWER_THAN src/old/main.cpp) #is this file newer?

IF(IS_DIRECTORY src/includes) # is src/includes folder of a file?

```

## Loops

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

SET( MyProject_SRC 
     "src/main.cpp"
	 "src/aux_code.cpp"
	 "src/aux_code2.cpp")
	 
FOREACH(FILE_SRC IN MyProeject_SRC)
MESSAGE(STATUS "Detected file: ${FILE_SRC}")
ENDFOREACH()
```

## Submodules

Cmake uses only one file, but it my be to our advantage to distrubute the cmake configuration in several folders

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

ADD_SUBDIRECTORY(lib)
ADD_SUBDIRECTORY(src)

#so in each subdirectory the should be a Cmakelist.txt
```

## External libraries

It is posible to retrieve external libraries that would be needed

```
PROJECT(MyProject)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

FIND_PACKAGE(wxWidgets)
#or to retrieve only certain components
FIND_PACKAGE(wxWidgets COMPONENTS core gl html base net)
#or to stop if the library isn't found
FIND_PACKAGE(wxWidget REQUIRED)
#in case of success, it creates the variables: wxWidget_FOUND, wxWidget_LIBRARIES and wxWidget_INCLUDE_DIR

INCLUDE_DIRECTORIES(${wxWidget_INCLUDE_DIR) 
TARGET_LINK_LIBRARIES(MyProject ${wxWidgets_LIBARIES})
```

## Dependencies

It is possible to create dependeincies between projects.

```
PROJECT(MyProject1)
CMAKE_MINIMUM_REQUIRED(VERSION XXX)

ADD_EXECUTABLE(MyProject1 "src/main.cpp")
ADD_EXECUTABLE(MyProject2 "src/other.cpp")

ADD_DEPENDENCY(MyProject2 MyProject1)
# MyProject2 depends on MyProject1

## Some intereting variables

- CMAKE_CURRENT_SOURCE_DIR: the route to the current folder of CMakeLists.txt
- CMAKE_MODULE_PATH : the route for seaching cmake plugins
- PROJECT_BINARY_DIR: the folder that is being used to store the build binaries
- CMAKE_INCLUDE_PATH: the folders in which the headers are being searched
- CMAKE_VERSION: cmake version
- CMAKE_SYSTEM: the name of the system
- CMAKE_SYSTEM_NAME: the name of the OS
- CMAKE_SYSTEM_PROCESSOR: the processor
- UNIX: if we are in *unix sistems
- WIN32: if we are in windows
- APPLE: if whe are in Os X
- CMAKE_C_COMPLIER_ID: indetifier of the C compiler
- CMAKE_CXX_COMPILER_ID: identifier of the c++ compiler
- CMAKE_COMPILER_IS_GNUCC: if the C compiler is a variant of gnu gcc
- CMAKE_COMPILER_IS_GNUCXX: if the c++ copiler is a variant of gnu g++
- CMAKE_C_COMPILER: the route to the c compiler
- CMAKE_C_FLAGS: configuration of the c compiler
- CMAKE_C_FLAGES_DEBUG: configuration of the C compiler in debug mode
- CMAKE_C_FLAGS_RELEASE: configuration of the C compiler in release mode
- CMAKE_SHARED_LINKER_FLAGS: compiler configuration for shared libraries
- BUILD_SHARED_LIBS: by default ADD_LIBRARIES is only for shared libraries. It is possible to change that

more at: gitlab.kitware.com/cmake/community/-/wikis/doc/cmake/Useful-variables
